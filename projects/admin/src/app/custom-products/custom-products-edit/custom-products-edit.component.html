<div class="animated fadeIn" *ngIf="!loading">
  <form
    class="row"
    [formGroup]="editForm"
    (ngSubmit)="updateItem(editForm.value)"
  >
    <div class="col-md-9">
      <div class="card">
        <div class="card-header">
          {{
            isNew
              ? 'New Custom Product'
              : 'Edit ' + editForm.controls['title'].value
          }}
        </div>
        <div class="card-block">
          <bx-form-field label="Title">
            <input
              type="text"
              class="form-control"
              placeholder="Title"
              formControlName="title"
              bxInputRef
            />
          </bx-form-field>
          <bx-form-field label="Code">
            <input
              type="text"
              class="form-control"
              placeholder="Code"
              formControlName="code"
              bxInputRef
            />
          </bx-form-field>
          <bx-form-field label="Price">
            <input
              type="tel"
              class="form-control"
              placeholder="Price"
              formControlName="price"
              bxInputRef
            />
          </bx-form-field>
          <bx-form-field label="Sale Amount">
            <input
              type="tel"
              class="form-control"
              placeholder="Sale Amount"
              formControlName="sale_amount"
              bxInputRef
            />
          </bx-form-field>
          <bx-form-field label="Sale Percent">
            <input
              type="tel"
              class="form-control"
              placeholder="Sale Percent"
              formControlName="sale_percent"
              bxInputRef
            />
          </bx-form-field>
          <bx-form-field label="Sale Start Date">
            <div class="input-group" dropdown>
              <input
                class="form-control"
                placeholder="Start date"
                bsDatepicker
                #dp_start="bsDatepicker"
                formControlName="sale_start_date"
                [bsConfig]="bsConfig"
              />
              <span
                class="input-group-append calendar-point"
                (click)="dp_start.show()"
              >
                <span class="input-group-text">
                  <span class="icon-calendar"></span>
                </span>
              </span>
            </div>
          </bx-form-field>
          <bx-form-field label="Sale End Date">
            <div class="input-group" dropdown>
              <input
                class="form-control"
                placeholder="End date"
                bsDatepicker
                #dp_end="bsDatepicker"
                formControlName="sale_end_date"
                [bsConfig]="bsConfig"
              />
              <span
                class="input-group-append calendar-point"
                (click)="dp_end.show()"
              >
                <span class="input-group-text">
                  <span class="icon-calendar"></span>
                </span>
              </span>
            </div>
            <span class="help-text"
              >If you want the sale to run to the end of the day be sure to
              select the next days date.</span
            >
          </bx-form-field>
          <bx-form-field label="Category">
            <bx-category-select
              category="58ac1318dc142c612ab61fad"
              [nested]="true"
              [parentForm]="editForm"
              [item]="item"
              field="category"
            ></bx-category-select>
          </bx-form-field>
          <bx-form-field label="Description">
            <angular-tinymce
              formControlName="description"
              [settings]="tinymce"
            ></angular-tinymce>
          </bx-form-field>
        </div>
      </div>
      <div class="card" formArrayName="settings">
        <div class="card-header">Product Settings</div>
        <div class="card-block">
          <accordion
            [closeOthers]="oneAtATime"
            dragula="setting"
            [(dragulaModel)]="editForm.get('settings')['controls']"
          >
            <accordion-group
              *ngFor="
                let setting of editForm.get('settings')['controls'];
                let i = index
              "
              [attr.data-id]="setting.controls._id.value"
              [attr.data-index]="i"
              #group
              [formGroupName]="i"
            >
              <div accordion-heading>
                <i
                  *ngIf="setting.controls._id.value"
                  class="icon-cursor-move icons font-xl mr-2"
                  [ngClass]="{ 'ignore-item': !setting.controls._id.value }"
                ></i>
                <span *ngIf="setting.controls.name.value; else other_title"
                  >{{ setting.controls.name.value }} -
                  {{ setting.controls.panel.value }}</span
                >
                <ng-template #other_title
                  >New setting ({{ setting.controls.panel.value }})</ng-template
                >
                <i
                  class="pull-right float-xs-right"
                  [ngClass]="{
                    'icon-arrow-up': group?.isOpen,
                    'icon-arrow-down': !group?.isOpen
                  }"
                ></i>
              </div>
              <!-- content -->
              <bx-custom-products-setting
                [group]="editForm.get('settings')['controls'][i]"
                [index]="i"
                [material_types]="material_types"
                [material_groups]="material_groups"
                [design_areas]="design_areas"
              >
              </bx-custom-products-setting>
              <button
                type="button"
                *ngIf="!setting.controls._id.value"
                class="btn btn-danger pull-right"
                (click)="removeSetting(i)"
              >
                Remove
              </button>
              <button
                type="button"
                *ngIf="setting.controls._id.value"
                class="btn btn-danger pull-right"
                (click)="deleteSetting(setting.controls._id.value, i)"
              >
                Delete
              </button>
              <div class="clearfix"></div>
            </accordion-group>
          </accordion>
        </div>
      </div>
      <bx-publishing-form
        [parentForm]="editForm"
        [item]="item"
        [hasSlug]="!isNew"
        [endpoint]="'custom-product'"
      >
      </bx-publishing-form>
      <bx-seo-form [parentForm]="editForm" [item]="item"></bx-seo-form>
    </div>
    <div class="col-md-3">
      <bx-single-image-upload
        title="Main Image"
        [config]="dropzone_config"
        [image]="item.image"
        (imageAdded)="imageAdded($event)"
        (imageRemoved)="imageRemoved()"
      ></bx-single-image-upload>
      <bx-single-image-upload
        title="Template"
        [config]="dropzone_config_template"
        [image]="item.template"
        (imageAdded)="templateAdded($event)"
        (imageRemoved)="templateRemoved()"
      ></bx-single-image-upload>
      <button class="btn btn-danger" (click)="reloadSvg($event)">Reload</button>
      <div
        [hidden]="true"
        *ngIf="loadSvg"
        [inlineSVG]="item.template.key"
        (onSVGInserted)="svgData($event)"
      ></div>
      <div class="form-group">
        <button class="btn btn-primary" [disabled]="!editForm.valid">
          {{ isNew ? 'Create' : 'Update' }}
        </button>
      </div>
    </div>
  </form>
</div>
